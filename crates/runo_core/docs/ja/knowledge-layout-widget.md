# レイアウトとウィジェット設計

## 1. レイアウトエンジンの基本戦略

よく使われる戦略は次の 3 つです。

1. Flow/Stack
   縦積み・横積み。実装が軽い
2. Flex
   比率配分や折り返しに強い
3. Constraint
   複雑な画面に強いが実装コストが高い

最初は Stack + 最小限の Flex から始めるのが実践的です。

## 2. 計測と配置を分ける

レイアウトは通常 2 フェーズです。

1. Measure
   子要素が必要サイズを返す
2. Arrange
   親が最終位置・最終サイズを決める

この分離がないと、テキストや可変サイズで破綻しやすいです。

## 3. ウィジェット API 設計

ウィジェット API は次を意識します。

1. 宣言的で読みやすい
2. 省略時のデフォルトが安全
3. ID と見た目を分離
4. レイアウト指定と見た目指定を分離

## 4. 状態付きウィジェット

Button 以外は内部状態が増えます。

1. TextField
   value, selection, caret, composition
2. ScrollView
   scroll offset, inertia, viewport
3. Select/Combo
   open/close, highlighted item

保持型では、これらをノード状態として持つか、外部 state と同期するかを決めます。

## 5. スタイリングモデル

主な方式:

1. 直接指定（builder で色・サイズ指定）
2. テーマ指定（theme object）
3. CSS 風指定（セレクタ）

小規模では builder + theme、拡大後に style system を足す方式が現実的です。

## 6. テキストとフォント

テキストは想像以上に難しいです。

1. フォールバックフォント
2. 改行と折り返し
3. 双方向テキスト
4. サブピクセルとアンチエイリアス

最初は単純描画でも、将来の shaping 追加余地を残した API にしておくと安全です。

## 7. ウィジェット追加時のテンプレート

1. ノード定義を追加
2. state へ登録/更新 API を追加
3. input 処理へ判定追加
4. paint 処理へ描画追加
5. UI API/builder を追加
6. 例とテストを追加

