# イベントループと入力モデル

## 1. イベントループの基本

イベントループは OS からのイベントを受け取り、アプリへ配送します。

1. ウィンドウイベント
   リサイズ、最小化、閉じる要求
2. ポインタイベント
   move/down/up/wheel
3. キーイベント
   key down/up、修飾キー、ショートカット
4. テキスト入力
   文字入力（IME 経由を含む）

## 2. 入力をどう正規化するか

GUI ライブラリは生イベントをそのまま使わず、フレーム単位で正規化します。

1. 瞬間イベント
   `pressed`, `released` のようにそのフレームだけ true
2. 継続状態
   `is_down`, `cursor_pos` のようにフレームを跨いで維持
3. 派生状態
   `clicked`, `dragging`, `double_click` など

## 3. ヒットテスト

どのウィジェットが入力対象かを判定する処理です。

1. z-order（前面優先）
2. 可視性（hidden/disabled）
3. クリッピング領域
4. ポインタイベント捕捉（capture）

## 4. フォーカス管理

キーボード入力やアクセシビリティの土台です。

1. 現在フォーカス中のノード ID
2. Tab/Shift+Tab のフォーカス移動規則
3. マウスクリック時のフォーカス更新
4. フォーカス喪失時の cleanup

## 5. ポインタキャプチャ

ドラッグ中の一貫性のために必要です。

1. down 時にキャプチャ開始
2. move/up は対象外へカーソルが出ても元ノードへ配送
3. up/cancel でキャプチャ解放

## 6. IME とテキスト入力

テキスト入力はキーイベントとは別に扱います。

1. 文字確定イベント
2. 変換中テキスト（preedit）
3. キャレット位置通知

## 7. 入力処理の品質チェック

1. 1 フレーム内で pressed/released の整合が取れている
2. 高 DPI で座標系がずれない
3. 最小化復帰後に入力状態が暴走しない
4. 複数ボタン同時押し時の仕様が定義されている

