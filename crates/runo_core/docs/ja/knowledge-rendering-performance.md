# 描画パイプラインとパフォーマンス

## 1. 描画パイプラインの基本

1. シーン構築
   図形・テキストなどの描画命令を積む
2. ラスタライズ/合成
   GPU 向けに実行可能な形へ変換
3. 提出と表示
   コマンドバッファ送信、present

## 2. よく効く最適化

1. 再利用可能データをキャッシュ
   フォント、グリフ、画像、パス
2. 差分更新
   変化した部分だけ再計算
3. overdraw 削減
   目に見えない領域の描画を減らす
4. バッチング
   同種コマンドをまとめて送る

## 3. CPU と GPU の役割分担

1. CPU が得意
   入力、レイアウト、状態更新、コマンド組み立て
2. GPU が得意
   大量ピクセル処理、合成、アンチエイリアス

分担が曖昧だと片側がボトルネックになります。

## 4. フレーム時間の見方

60 FPS を目標にするなら、1 フレームの予算は約 16.6ms です。

1. update
2. layout
3. paint record
4. GPU submit/present

どこで時間を使っているかを区間計測するのが最優先です。

## 5. 高 DPI と座標

1. 論理座標と物理座標を混同しない
2. フォントサイズとスケール係数を整合させる
3. ヒットテストと描画座標を同じ基準にする

## 6. クリッピング

1. スクロール領域の子を clip する
2. 親外にはみ出る描画を抑制する
3. ヒットテストでも clip を考慮する

描画と入力で clip 判定が一致しないとバグになります。

## 7. 実装初期の性能ガイドライン

1. まず正しさ
2. 次に計測
3. その後局所最適化
4. 最後に設計最適化

最適化を先にやるより、観測可能性を先に作るほうが最終的に速いです。

